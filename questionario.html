<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Questionario - SkinAI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/logo.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #D1A78C;
      --primary-dark: #B78A72;
      --secondary: #E8D9C5;
      --accent: #886349;
      --light: #FAF3EB;
      --white: #ffffff;
      --gray-100: #f7f7f7;
      --gray-200: #e5e5e5;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --success: #22c55e;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #FDF8F5 0%, #F9E8E0 50%, #F5DED4 100%);
      min-height: 100vh;
      color: var(--gray-700);
      line-height: 1.6;
    }
    h1, h2, h3 { font-family: 'Cormorant Garamond', serif; color: var(--accent); }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { height: 40px; }
    .back-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--gray-500);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.3s;
    }
    .back-link:hover { color: var(--accent); }
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      min-height: calc(100vh - 70px);
      max-width: 1400px;
      margin: 0 auto;
    }
    .illustration-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 3rem;
      position: relative;
    }
    .illustration-panel::before {
      content: '';
      position: absolute;
      top: 10%;
      left: 10%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(209,167,140,0.3) 0%, transparent 70%);
      border-radius: 50%;
    }
    .illustration-content { position: relative; z-index: 1; text-align: center; }
    .illustration-image {
      width: 280px;
      height: auto;
      margin-bottom: 2rem;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,0.1));
      border-radius: 20px;
    }
    .illustration-title { font-size: 2.5rem; margin-bottom: 1rem; line-height: 1.2; }
    .illustration-subtitle { color: var(--gray-500); font-size: 1.1rem; max-width: 300px; margin: 0 auto; }
    .progress-container { margin-top: 3rem; }
    .progress-steps { display: flex; align-items: center; gap: 0.5rem; }
    .progress-step { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .step-circle {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .step-circle.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(209,167,140,0.4);
    }
    .step-circle.completed { background: var(--success); color: white; }
    .step-circle.pending { background: var(--gray-200); color: var(--gray-500); }
    .step-label { font-size: 0.75rem; color: var(--gray-500); text-align: center; max-width: 80px; }
    .step-line { width: 40px; height: 3px; background: var(--gray-200); margin-bottom: 1.5rem; }
    .step-line.completed { background: var(--success); }
    .form-panel { padding: 2rem 3rem; overflow-y: auto; }
    .form-card {
      background: white;
      border-radius: 24px;
      padding: 2.5rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      max-width: 600px;
    }
    .form-header { margin-bottom: 2rem; }
    .form-title { font-size: 2rem; margin-bottom: 0.5rem; }
    .form-subtitle { color: var(--gray-500); font-size: 0.95rem; }
    .form-section { display: none; }
    .form-section.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .question-group { margin-bottom: 2rem; }
    .question-label { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; margin-bottom: 1rem; color: var(--gray-700); }
    .help-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--secondary);
      border: none;
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .help-btn:hover { background: var(--primary); color: white; transform: scale(1.1); }
    .pill-options { display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .pill-option { position: relative; }
    .pill-option input { position: absolute; opacity: 0; pointer-events: none; }
    .pill-option label {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background: var(--gray-100);
      border: 2px solid transparent;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    .pill-option label:hover { background: var(--secondary); }
    .pill-option input:checked + label {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(209,167,140,0.3);
    }
    .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .checkbox-option { position: relative; }
    .checkbox-option input { position: absolute; opacity: 0; pointer-events: none; }
    .checkbox-option label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: var(--gray-100);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    .checkbox-option label::before {
      content: '';
      width: 22px;
      height: 22px;
      border: 2px solid var(--gray-200);
      border-radius: 6px;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .checkbox-option label:hover { background: var(--secondary); }
    .checkbox-option input:checked + label { background: rgba(209,167,140,0.15); border-color: var(--primary); }
    .checkbox-option input:checked + label::before {
      background: var(--primary);
      border-color: var(--primary);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
      background-size: 14px;
      background-position: center;
      background-repeat: no-repeat;
    }
    .select-wrapper { position: relative; }
    .select-wrapper select {
      width: 100%;
      padding: 1rem 1.25rem;
      background: var(--gray-100);
      border: 2px solid transparent;
      border-radius: 12px;
      font-size: 0.95rem;
      color: var(--gray-700);
      cursor: pointer;
      appearance: none;
      transition: all 0.3s;
    }
    .select-wrapper select:focus { outline: none; border-color: var(--primary); background: white; }
    .select-wrapper::after {
      content: 'â–¼';
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7rem;
      color: var(--gray-500);
      pointer-events: none;
    }
    .makeup-toggle { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
    .toggle-option { flex: 1; position: relative; }
    .toggle-option input { position: absolute; opacity: 0; pointer-events: none; }
    .toggle-option label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      background: var(--gray-100);
      border: 2px solid transparent;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .toggle-option label .icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .toggle-option label:hover { background: var(--secondary); }
    .toggle-option input:checked + label {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(209,167,140,0.3);
    }
    .conditional-section { display: none; animation: fadeIn 0.4s ease; }
    .conditional-section.visible { display: block; }
    .form-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--gray-200);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }
    .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
    .btn-secondary:hover { background: var(--gray-200); }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(209,167,140,0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(209,167,140,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .message-box { padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: none; }
    .message-box.error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; display: block; }
    .message-box.success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; display: block; }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      animation: modalIn 0.3s ease;
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .modal-title { font-size: 1.25rem; }
    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-100);
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-body { color: var(--gray-700); line-height: 1.7; }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 900px) {
      .main-container { grid-template-columns: 1fr; }
      .illustration-panel { display: none; }
      .form-panel { padding: 1.5rem; }
      .form-card { padding: 1.5rem; }
      .checkbox-grid { grid-template-columns: 1fr; }
      .makeup-toggle { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html"><img src="images/logo.png" alt="SkinAI" class="logo"></a>
    <a href="dashboard.html" class="back-link">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      Dashboard
    </a>
  </header>
  <div class="main-container">
    <div class="illustration-panel">
      <div class="illustration-content">
        <img src="images/skincare-illustration.jpg" alt="Skincare" class="illustration-image">
        <h2 class="illustration-title">Scopri la tua pelle</h2>
        <p class="illustration-subtitle">Rispondi a poche domande per ricevere un'analisi personalizzata</p>
        <div class="progress-container">
          <div class="progress-steps">
            <div class="progress-step">
              <div class="step-circle active" id="step-circle-1">1</div>
              <span class="step-label">La Tua Pelle</span>
            </div>
            <div class="step-line" id="step-line-1"></div>
            <div class="progress-step">
              <div class="step-circle pending" id="step-circle-2">2</div>
              <span class="step-label">I Tuoi Colori</span>
            </div>
            <div class="step-line" id="step-line-2"></div>
            <div class="progress-step">
              <div class="step-circle pending" id="step-circle-3">3</div>
              <span class="step-label">Make-up</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="form-panel">
      <div class="form-card">
        <div class="message-box" id="message-box"></div>
        <!-- Section 1 -->
        <div class="form-section active" id="section-1">
          <div class="form-header">
            <h1 class="form-title">La Tua Pelle</h1>
            <p class="form-subtitle">Aiutaci a capire meglio la tua pelle per un'analisi personalizzata</p>
          </div>
          
          <!-- EtÃ  -->
          <div class="question-group">
            <div class="question-label">La tua etÃ  <button class="help-btn" onclick="showHelp('eta')">?</button></div>
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 2px solid #e5d4c1;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="font-size: 3rem; font-weight: 700; color: #8b6f47;" id="age-display">--</div>
                <div style="flex: 1;">
                  <div style="font-size: 1.2rem; color: #8b6f47; font-weight: 600;">anni</div>
                  <div style="font-size: 0.9rem; color: #999; margin-top: 0.25rem;">Calcolata dalla tua data di nascita</div>
                </div>
              </div>
              <input type="hidden" name="age_range" id="age_range_hidden" required>
            </div>
          </div>
          
          <!-- Allergie -->
          <div class="question-group">
            <div class="question-label">Hai allergie o intolleranze a ingredienti cosmetici? <button class="help-btn" onclick="showHelp('allergie')">?</button></div>
            <div class="pill-options" style="margin-bottom: 1rem;">
              <div class="pill-option"><input type="radio" name="has_allergies" id="allergy_no" value="no" onchange="toggleAllergyDetails()"><label for="allergy_no">No, nessuna</label></div>
              <div class="pill-option"><input type="radio" name="has_allergies" id="allergy_yes" value="yes" onchange="toggleAllergyDetails()"><label for="allergy_yes">SÃ¬, ho allergie</label></div>
            </div>
            <div id="allergy-details" style="display: none;">
              <div class="checkbox-grid" style="margin-bottom: 1rem;">
                <div class="checkbox-option"><input type="checkbox" name="allergies" id="all1" value="profumi"><label for="all1">Profumi/Fragranze</label></div>
                <div class="checkbox-option"><input type="checkbox" name="allergies" id="all2" value="parabeni"><label for="all2">Parabeni</label></div>
                <div class="checkbox-option"><input type="checkbox" name="allergies" id="all3" value="nichel"><label for="all3">Nichel</label></div>
                <div class="checkbox-option"><input type="checkbox" name="allergies" id="all4" value="siliconi"><label for="all4">Siliconi</label></div>
                <div class="checkbox-option"><input type="checkbox" name="allergies" id="all5" value="alcool"><label for="all5">Alcool</label></div>
                <div class="checkbox-option"><input type="checkbox" name="allergies" id="all6" value="oli_essenziali"><label for="all6">Oli essenziali</label></div>
              </div>
              <div style="margin-top: 0.5rem;">
                <label style="font-size: 0.9rem; color: var(--gray-600); display: block; margin-bottom: 0.5rem;">Altre allergie (specifica):</label>
                <input type="text" id="other_allergies" placeholder="Es: lattice, lanolina..." style="width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 0.95rem;">
              </div>
            </div>
          </div>
          
          <div class="question-group">
            <div class="question-label">Come si comporta la tua pelle durante il giorno? <button class="help-btn" onclick="showHelp('comportamento')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="skin_behavior" id="sb1" value="lucida"><label for="sb1">Tende a lucidarsi</label></div>
              <div class="pill-option"><input type="radio" name="skin_behavior" id="sb2" value="secca"><label for="sb2">Si secca</label></div>
              <div class="pill-option"><input type="radio" name="skin_behavior" id="sb3" value="normale"><label for="sb3">Rimane normale</label></div>
              <div class="pill-option"><input type="radio" name="skin_behavior" id="sb4" value="mista"><label for="sb4">A zone (mista)</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Com'Ã¨ la tua pelle al mattino appena sveglia? <button class="help-btn" onclick="showHelp('mattino')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="morning_skin" id="ms1" value="lucida"><label for="ms1">Lucida</label></div>
              <div class="pill-option"><input type="radio" name="morning_skin" id="ms2" value="secca"><label for="ms2">Secca</label></div>
              <div class="pill-option"><input type="radio" name="morning_skin" id="ms3" value="normale"><label for="ms3">Normale</label></div>
              <div class="pill-option"><input type="radio" name="morning_skin" id="ms4" value="mista"><label for="ms4">A zone</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Dopo la detersione, come reagisce la pelle? <button class="help-btn" onclick="showHelp('detersione')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="after_cleansing" id="ac1" value="tira"><label for="ac1">Tira o brucia</label></div>
              <div class="pill-option"><input type="radio" name="after_cleansing" id="ac2" value="arrossa"><label for="ac2">Si arrossa</label></div>
              <div class="pill-option"><input type="radio" name="after_cleansing" id="ac3" value="nessuna"><label for="ac3">Nessuna reazione</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Quali problematiche noti sulla tua pelle? <button class="help-btn" onclick="showHelp('problematiche')">?</button></div>
            <div class="checkbox-grid">
              <div class="checkbox-option"><input type="checkbox" name="concerns" id="c1" value="acne"><label for="c1">Acne / Brufoli</label></div>
              <div class="checkbox-option"><input type="checkbox" name="concerns" id="c2" value="macchie"><label for="c2">Macchie scure</label></div>
              <div class="checkbox-option"><input type="checkbox" name="concerns" id="c3" value="rughe"><label for="c3">Rughe / Linee</label></div>
              <div class="checkbox-option"><input type="checkbox" name="concerns" id="c4" value="pori"><label for="c4">Pori dilatati</label></div>
              <div class="checkbox-option"><input type="checkbox" name="concerns" id="c5" value="rossori"><label for="c5">Rossori</label></div>
              <div class="checkbox-option"><input type="checkbox" name="concerns" id="c6" value="secchezza"><label for="c6">Secchezza</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Quanta acqua bevi al giorno? <button class="help-btn" onclick="showHelp('acqua')">?</button></div>
            <div class="select-wrapper">
              <select id="water_intake">
                <option value="">Seleziona...</option>
                <option value="poco">Meno di 1 litro</option>
                <option value="medio">1-2 litri</option>
                <option value="molto">PiÃ¹ di 2 litri</option>
              </select>
            </div>
          </div>
          <div class="form-navigation">
            <div></div>
            <button class="btn btn-primary" onclick="nextSection(2)">Continua <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
          </div>
        </div>
        <!-- Section 2 -->
        <div class="form-section" id="section-2">
          <div class="form-header">
            <h1 class="form-title">I Tuoi Colori</h1>
            <p class="form-subtitle">Scopriamo la tua armocromia per consigli personalizzati</p>
          </div>
          <div class="question-group">
            <div class="question-label">Qual Ã¨ il colore naturale dei tuoi capelli? <button class="help-btn" onclick="showHelp('capelli')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="hair_color" id="hc1" value="biondo"><label for="hc1">Biondo</label></div>
              <div class="pill-option"><input type="radio" name="hair_color" id="hc2" value="castano_chiaro"><label for="hc2">Castano chiaro</label></div>
              <div class="pill-option"><input type="radio" name="hair_color" id="hc3" value="castano_scuro"><label for="hc3">Castano scuro</label></div>
              <div class="pill-option"><input type="radio" name="hair_color" id="hc4" value="nero"><label for="hc4">Nero</label></div>
              <div class="pill-option"><input type="radio" name="hair_color" id="hc5" value="rosso"><label for="hc5">Rosso/Ramato</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Di che colore sono i tuoi occhi? <button class="help-btn" onclick="showHelp('occhi')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="eye_color" id="ec1" value="azzurri"><label for="ec1">Azzurri</label></div>
              <div class="pill-option"><input type="radio" name="eye_color" id="ec2" value="verdi"><label for="ec2">Verdi</label></div>
              <div class="pill-option"><input type="radio" name="eye_color" id="ec3" value="nocciola"><label for="ec3">Nocciola</label></div>
              <div class="pill-option"><input type="radio" name="eye_color" id="ec4" value="marroni"><label for="ec4">Marroni</label></div>
              <div class="pill-option"><input type="radio" name="eye_color" id="ec5" value="neri"><label for="ec5">Neri</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Come reagisce la tua pelle al sole? <button class="help-btn" onclick="showHelp('sole')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="sun_reaction" id="sr1" value="brucia"><label for="sr1">Si brucia facilmente</label></div>
              <div class="pill-option"><input type="radio" name="sun_reaction" id="sr2" value="abbronza_poco"><label for="sr2">Si abbronza poco</label></div>
              <div class="pill-option"><input type="radio" name="sun_reaction" id="sr3" value="abbronza_bene"><label for="sr3">Si abbronza bene</label></div>
              <div class="pill-option"><input type="radio" name="sun_reaction" id="sr4" value="abbronza_molto"><label for="sr4">Si abbronza molto</label></div>
            </div>
          </div>
          <div class="question-group">
            <div class="question-label">Di che colore sono le vene del polso? <button class="help-btn" onclick="showHelp('vene')">?</button></div>
            <div class="pill-options">
              <div class="pill-option"><input type="radio" name="vein_color" id="vc1" value="blu"><label for="vc1">Blu/Viola</label></div>
              <div class="pill-option"><input type="radio" name="vein_color" id="vc2" value="verde"><label for="vc2">Verde</label></div>
              <div class="pill-option"><input type="radio" name="vein_color" id="vc3" value="miste"><label for="vc3">Miste</label></div>
            </div>
          </div>
          <div class="form-navigation">
            <button class="btn btn-secondary" onclick="prevSection(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Indietro</button>
            <button class="btn btn-primary" onclick="nextSection(3)">Continua <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
          </div>
        </div>
        <!-- Section 3 -->
        <div class="form-section" id="section-3">
          <div class="form-header">
            <h1 class="form-title">Make-up</h1>
            <p class="form-subtitle">Personalizza i consigli in base alle tue preferenze</p>
          </div>
          <div class="question-group">
            <div class="question-label">Usi il make-up?</div>
            <div class="makeup-toggle">
              <div class="toggle-option">
                <input type="radio" name="uses_makeup" id="mu_yes" value="yes" onchange="toggleMakeupQuestions()">
                <label for="mu_yes"><span class="icon">ðŸ’„</span>SÃ¬, lo uso</label>
              </div>
              <div class="toggle-option">
                <input type="radio" name="uses_makeup" id="mu_no" value="no" onchange="toggleMakeupQuestions()">
                <label for="mu_no"><span class="icon">ðŸŒ¿</span>No, preferisco il naturale</label>
              </div>
            </div>
          </div>
          <div class="conditional-section" id="makeup-questions">
            <div class="question-group">
              <div class="question-label">Che tipo di coprenza preferisci per il fondotinta? <button class="help-btn" onclick="showHelp('coprenza')">?</button></div>
              <div class="pill-options">
                <div class="pill-option"><input type="radio" name="coverage" id="cov1" value="leggera"><label for="cov1">Leggera / Naturale</label></div>
                <div class="pill-option"><input type="radio" name="coverage" id="cov2" value="media"><label for="cov2">Media</label></div>
                <div class="pill-option"><input type="radio" name="coverage" id="cov3" value="alta"><label for="cov3">Alta / Coprente</label></div>
              </div>
            </div>
            <div class="question-group">
              <div class="question-label">Che finish preferisci? <button class="help-btn" onclick="showHelp('finish')">?</button></div>
              <div class="pill-options">
                <div class="pill-option"><input type="radio" name="finish" id="fin1" value="matte"><label for="fin1">Matte / Opaco</label></div>
                <div class="pill-option"><input type="radio" name="finish" id="fin2" value="satinato"><label for="fin2">Satinato</label></div>
                <div class="pill-option"><input type="radio" name="finish" id="fin3" value="luminoso"><label for="fin3">Luminoso / Glow</label></div>
              </div>
            </div>
            <div class="question-group">
              <div class="question-label">Quali esigenze specifiche hai? <button class="help-btn" onclick="showHelp('esigenze')">?</button></div>
              <div class="checkbox-grid">
                <div class="checkbox-option"><input type="checkbox" name="needs" id="n1" value="vegano"><label for="n1">Prodotti vegani</label></div>
                <div class="checkbox-option"><input type="checkbox" name="needs" id="n2" value="non_comedogenico"><label for="n2">Non comedogenico</label></div>
                <div class="checkbox-option"><input type="checkbox" name="needs" id="n3" value="lunga_tenuta"><label for="n3">Lunga tenuta</label></div>
                <div class="checkbox-option"><input type="checkbox" name="needs" id="n4" value="idratante"><label for="n4">Idratante</label></div>
              </div>
            </div>
          </div>
          <div class="form-navigation">
            <button class="btn btn-secondary" onclick="prevSection(2)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Indietro</button>
            <button class="btn btn-primary" onclick="submitQuestionnaire()" id="submit-btn">Completa <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="help-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ðŸ’¡ Suggerimento</h3>
        <button class="modal-close" onclick="closeHelp()">Ã—</button>
      </div>
      <div class="modal-body" id="help-content"></div>
    </div>
  </div>
  <script src="js/api.js"></script>
  <script>
    if (!api.isAuthenticated()) { window.location.href = 'auth.html'; }
    let currentSection = 1;
    function showMessage(text, type) {
      const box = document.getElementById('message-box');
      box.textContent = text;
      box.className = 'message-box ' + type;
      setTimeout(() => { box.className = 'message-box'; }, 5000);
    }
    async function loadPreviousData() {
      try {
        const data = await api.getLastQuestionnaire();
        if (data && data.data) {
          const q = data.data;
          if (q.skin_behavior) { const el = document.querySelector(`input[name="skin_behavior"][value="${q.skin_behavior}"]`); if (el) el.checked = true; }
          if (q.morning_skin) { const el = document.querySelector(`input[name="morning_skin"][value="${q.morning_skin}"]`); if (el) el.checked = true; }
          if (q.after_cleansing) { const el = document.querySelector(`input[name="after_cleansing"][value="${q.after_cleansing}"]`); if (el) el.checked = true; }
          if (q.concerns && Array.isArray(q.concerns)) { q.concerns.forEach(c => { const el = document.querySelector(`input[name="concerns"][value="${c}"]`); if (el) el.checked = true; }); }
          if (q.water_intake) { document.getElementById('water_intake').value = q.water_intake; }
          if (q.hair_color) { const el = document.querySelector(`input[name="hair_color"][value="${q.hair_color}"]`); if (el) el.checked = true; }
          if (q.eye_color) { const el = document.querySelector(`input[name="eye_color"][value="${q.eye_color}"]`); if (el) el.checked = true; }
          if (q.sun_reaction) { const el = document.querySelector(`input[name="sun_reaction"][value="${q.sun_reaction}"]`); if (el) el.checked = true; }
          if (q.vein_color) { const el = document.querySelector(`input[name="vein_color"][value="${q.vein_color}"]`); if (el) el.checked = true; }
          if (q.uses_makeup) { const el = document.querySelector(`input[name="uses_makeup"][value="${q.uses_makeup}"]`); if (el) { el.checked = true; toggleMakeupQuestions(); } }
          if (q.coverage) { const el = document.querySelector(`input[name="coverage"][value="${q.coverage}"]`); if (el) el.checked = true; }
          if (q.finish) { const el = document.querySelector(`input[name="finish"][value="${q.finish}"]`); if (el) el.checked = true; }
          if (q.needs && Array.isArray(q.needs)) { q.needs.forEach(n => { const el = document.querySelector(`input[name="needs"][value="${n}"]`); if (el) el.checked = true; }); }
          showMessage('Risposte precedenti caricate. Puoi modificarle se necessario.', 'success');
        }
      } catch (e) { console.log('[SkinAI] No previous questionnaire found'); }
    }
    loadPreviousData();
    function toggleAllergyDetails() {
      const hasAllergies = document.querySelector('input[name="has_allergies"]:checked')?.value;
      const detailsDiv = document.getElementById('allergy-details');
      if (hasAllergies === 'yes') {
        detailsDiv.style.display = 'block';
      } else {
        detailsDiv.style.display = 'none';
      }
    }
    
    function validateSection(sectionNum) {
      let errors = [];
      
      if (sectionNum === 1) {
        const ageRange = document.querySelector('input[name="age_range"]:checked');
        const hasAllergies = document.querySelector('input[name="has_allergies"]:checked');
        const skinBehavior = document.querySelector('input[name="skin_behavior"]:checked');
        const morningSkin = document.querySelector('input[name="morning_skin"]:checked');
        const afterCleansing = document.querySelector('input[name="after_cleansing"]:checked');
        
        if (!ageRange) errors.push('Fascia d\'etÃ ');
        if (!hasAllergies) errors.push('Allergie o intolleranze');
        if (!skinBehavior) errors.push('Come si comporta la tua pelle durante il giorno');
        if (!morningSkin) errors.push('Come Ã¨ la tua pelle al mattino');
        if (!afterCleansing) errors.push('Come reagisce la pelle dopo la detersione');
      }
      
      if (sectionNum === 2) {
        const hairColor = document.querySelector('input[name="hair_color"]:checked');
        const eyeColor = document.querySelector('input[name="eye_color"]:checked');
        const sunReaction = document.querySelector('input[name="sun_reaction"]:checked');
        const veinColor = document.querySelector('input[name="vein_color"]:checked');
        
        if (!hairColor) errors.push('Colore dei capelli');
        if (!eyeColor) errors.push('Colore degli occhi');
        if (!sunReaction) errors.push('Reazione al sole');
        if (!veinColor) errors.push('Colore delle vene');
      }
      
      if (sectionNum === 3) {
        const usesMakeup = document.querySelector('input[name="uses_makeup"]:checked');
        if (!usesMakeup) errors.push('Preferenza make-up');
      }
      
      if (errors.length > 0) {
        alert('âš ï¸ Completa i seguenti campi prima di continuare:\n\nâ€¢ ' + errors.join('\nâ€¢ '));
        return false;
      }
      return true;
    }
    
    function nextSection(num) {
      // Valida la sezione corrente prima di procedere
      if (!validateSection(currentSection)) {
        return;
      }
      
      document.getElementById(`section-${currentSection}`).classList.remove('active');
      document.getElementById(`section-${num}`).classList.add('active');
      document.getElementById(`step-circle-${currentSection}`).classList.remove('active');
      document.getElementById(`step-circle-${currentSection}`).classList.add('completed');
      document.getElementById(`step-circle-${currentSection}`).innerHTML = 'âœ“';
      document.getElementById(`step-line-${currentSection}`).classList.add('completed');
      document.getElementById(`step-circle-${num}`).classList.remove('pending');
      document.getElementById(`step-circle-${num}`).classList.add('active');
      currentSection = num;
      window.scrollTo(0, 0);
    }
    function prevSection(num) {
      document.getElementById(`section-${currentSection}`).classList.remove('active');
      document.getElementById(`section-${num}`).classList.add('active');
      currentSection = num;
      window.scrollTo(0, 0);
    }
    function toggleMakeupQuestions() {
      const usesMakeup = document.querySelector('input[name="uses_makeup"]:checked')?.value;
      const questionsDiv = document.getElementById('makeup-questions');
      if (usesMakeup === 'yes') { questionsDiv.classList.add('visible'); } else { questionsDiv.classList.remove('visible'); }
    }
    function collectFormData() {
      return {
        age_range: document.querySelector('input[name="age_range"]:checked')?.value || '',
        has_allergies: document.querySelector('input[name="has_allergies"]:checked')?.value || 'no',
        allergies: Array.from(document.querySelectorAll('input[name="allergies"]:checked')).map(el => el.value),
        other_allergies: document.getElementById('other_allergies')?.value || '',
        skin_behavior: document.querySelector('input[name="skin_behavior"]:checked')?.value || '',
        morning_skin: document.querySelector('input[name="morning_skin"]:checked')?.value || '',
        after_cleansing: document.querySelector('input[name="after_cleansing"]:checked')?.value || '',
        concerns: Array.from(document.querySelectorAll('input[name="concerns"]:checked')).map(el => el.value),
        water_intake: document.getElementById('water_intake')?.value || '',
        hair_color: document.querySelector('input[name="hair_color"]:checked')?.value || '',
        eye_color: document.querySelector('input[name="eye_color"]:checked')?.value || '',
        sun_reaction: document.querySelector('input[name="sun_reaction"]:checked')?.value || '',
        vein_color: document.querySelector('input[name="vein_color"]:checked')?.value || '',
        uses_makeup: document.querySelector('input[name="uses_makeup"]:checked')?.value || 'no',
        coverage: document.querySelector('input[name="coverage"]:checked')?.value || '',
        finish: document.querySelector('input[name="finish"]:checked')?.value || '',
        needs: Array.from(document.querySelectorAll('input[name="needs"]:checked')).map(el => el.value)
      };
    }
    async function submitQuestionnaire() {
      // Valida la sezione make-up prima di procedere
      if (!validateSection(3)) {
        return;
      }
      
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Salvataggio...';
      const data = collectFormData();
      try {
        await api.submitQuestionnaire(data);
        localStorage.setItem('skinai_questionnaire_completed', 'true');
        showMessage('Questionario salvato con successo!', 'success');
        setTimeout(() => { window.location.href = 'upload.html'; }, 1000);
      } catch (error) {
        console.error('[SkinAI] Submit error:', error);
        showMessage(error.message || 'Errore nel salvataggio. Verifica di essere connesso e riprova.', 'error');
        btn.disabled = false;
        btn.innerHTML = 'Completa <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>';
      }
    }
    const helpTexts = {
      'comportamento': 'Osserva la tua pelle verso metÃ  giornata, senza aver applicato prodotti. Se noti luciditÃ  sulla zona T (fronte, naso, mento), la tua pelle tende ad essere grassa.',
      'mattino': 'Appena sveglia, prima di lavarti il viso, osserva come appare la tua pelle. Questo ti aiuta a capire come la tua pelle si comporta naturalmente.',
      'detersione': 'Dopo aver lavato il viso con il tuo detergente abituale, aspetta 15-20 minuti senza applicare nulla. Osserva come si sente la pelle.',
      'problematiche': 'Seleziona tutte le problematiche che noti sulla tua pelle. Non preoccuparti se ne hai piÃ¹ di una, Ã¨ molto comune!',
      'acqua': 'L\'idratazione interna influisce molto sulla salute della pelle. Bere almeno 1.5-2 litri di acqua al giorno aiuta a mantenere la pelle idratata.',
      'capelli': 'Considera il colore naturale dei tuoi capelli, non quello tinto. Se li tingi da molto tempo, pensa a come erano prima.',
      'occhi': 'Osserva i tuoi occhi alla luce naturale. Se hai dubbi, il colore predominante Ã¨ quello che vedi piÃ¹ spesso.',
      'sole': 'Pensa a come reagisce la tua pelle dopo un\'esposizione al sole di circa 30 minuti senza protezione.',
      'vene': 'Guarda le vene all\'interno del polso alla luce naturale. Se appaiono blu/viola hai un sottotono freddo, se verdi hai un sottotono caldo.',
      'coprenza': 'La coprenza indica quanto il fondotinta nasconde le imperfezioni. Leggera per un effetto naturale, alta per coprire acne o macchie.',
      'finish': 'Il finish Ã¨ l\'effetto finale sulla pelle. Matte per pelle grassa, satinato per un effetto naturale, luminoso per un effetto glow.',
      'esigenze': 'Seleziona le caratteristiche importanti per te. Non comedogenico significa che non ostruisce i pori.'
    };
    function showHelp(topic) {
      document.getElementById('help-content').textContent = helpTexts[topic] || 'Informazione non disponibile.';
      document.getElementById('help-modal').classList.add('active');
    }
    function closeHelp() { document.getElementById('help-modal').classList.remove('active'); }
    document.getElementById('help-modal').addEventListener('click', function(e) { if (e.target === this) closeHelp(); });
  </script>
  <script src="js/api.js"></script>

  <script>
    // Calcola e mostra etÃ  da data di nascita
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // Carica profilo utente
        const user = api.getCurrentUser();
        if (!user || !user.birth_date) {
          // Prova a caricare da API
          try {
            const profile = await api.getUserProfile();
            if (profile && profile.birth_date) {
              user.birth_date = profile.birth_date;
            }
          } catch (e) {
            console.error('[SkinAI] Errore caricamento profilo:', e);
          }
        }

        if (user && user.birth_date) {
          const birthDate = new Date(user.birth_date);
          const today = new Date();
          const age = Math.floor((today - birthDate) / 31557600000); // millisecondi in un anno

          // Mostra etÃ 
          document.getElementById('age-display').textContent = age;

          // Calcola fascia d'etÃ  per backend
          let ageRange;
          if (age < 18) ageRange = 'under18';
          else if (age <= 25) ageRange = '18-25';
          else if (age <= 35) ageRange = '26-35';
          else if (age <= 45) ageRange = '36-45';
          else if (age <= 55) ageRange = '46-55';
          else ageRange = 'over55';

          document.getElementById('age_range_hidden').value = ageRange;
          console.log('[SkinAI] EtÃ  calcolata:', age, 'Fascia:', ageRange);
        } else {
          console.warn('[SkinAI] Data di nascita non trovata');
          document.getElementById('age-display').textContent = '?';
          document.getElementById('age-display').nextElementSibling.querySelector('div').textContent = 'Data di nascita non disponibile';
        }
      } catch (error) {
        console.error('[SkinAI] Errore calcolo etÃ :', error);
      }
    });
  </script>

</body>
</html>
